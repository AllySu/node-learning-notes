<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>cluster模块概览 | Node.js学习指南</title>
    <meta name="description" content="Node.js笔记系统整理">
    <meta name="generator" content="VuePress 1.3.0">
    <link rel="icon" href="/node-learning-notes/logo.png">
  <link rel="manifest" href="/node-learning-notes/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/node-learning-notes/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/node-learning-notes/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
  <meta name="apple-mobile-web-app-status-bar-style">
    
    <link rel="preload" href="/node-learning-notes/assets/css/0.styles.04d71374.css" as="style"><link rel="preload" href="/node-learning-notes/assets/js/app.06995101.js" as="script"><link rel="preload" href="/node-learning-notes/assets/js/4.cbb566af.js" as="script"><link rel="preload" href="/node-learning-notes/assets/js/102.bed33a4e.js" as="script"><link rel="prefetch" href="/node-learning-notes/assets/js/10.1df831e5.js"><link rel="prefetch" href="/node-learning-notes/assets/js/100.faed81e1.js"><link rel="prefetch" href="/node-learning-notes/assets/js/101.4ca9de43.js"><link rel="prefetch" href="/node-learning-notes/assets/js/103.47cfeeb4.js"><link rel="prefetch" href="/node-learning-notes/assets/js/104.99382f62.js"><link rel="prefetch" href="/node-learning-notes/assets/js/105.a09c57ad.js"><link rel="prefetch" href="/node-learning-notes/assets/js/106.e0e65ae5.js"><link rel="prefetch" href="/node-learning-notes/assets/js/107.006157e7.js"><link rel="prefetch" href="/node-learning-notes/assets/js/11.6d248a1f.js"><link rel="prefetch" href="/node-learning-notes/assets/js/12.089b9acc.js"><link rel="prefetch" href="/node-learning-notes/assets/js/13.7503e5c6.js"><link rel="prefetch" href="/node-learning-notes/assets/js/14.ea26514e.js"><link rel="prefetch" href="/node-learning-notes/assets/js/15.6f7e5a72.js"><link rel="prefetch" href="/node-learning-notes/assets/js/16.15f31946.js"><link rel="prefetch" href="/node-learning-notes/assets/js/17.546f352d.js"><link rel="prefetch" href="/node-learning-notes/assets/js/18.43cadce8.js"><link rel="prefetch" href="/node-learning-notes/assets/js/19.20c00e37.js"><link rel="prefetch" href="/node-learning-notes/assets/js/20.d4bd9d39.js"><link rel="prefetch" href="/node-learning-notes/assets/js/21.147d3198.js"><link rel="prefetch" href="/node-learning-notes/assets/js/22.822af822.js"><link rel="prefetch" href="/node-learning-notes/assets/js/23.ad0f4e46.js"><link rel="prefetch" href="/node-learning-notes/assets/js/24.4ed1364a.js"><link rel="prefetch" href="/node-learning-notes/assets/js/25.e8be0e71.js"><link rel="prefetch" href="/node-learning-notes/assets/js/26.a4b68f4e.js"><link rel="prefetch" href="/node-learning-notes/assets/js/27.eaeaac83.js"><link rel="prefetch" href="/node-learning-notes/assets/js/28.ce8ab57d.js"><link rel="prefetch" href="/node-learning-notes/assets/js/29.0b3e19ed.js"><link rel="prefetch" href="/node-learning-notes/assets/js/30.409d36e7.js"><link rel="prefetch" href="/node-learning-notes/assets/js/31.dc762526.js"><link rel="prefetch" href="/node-learning-notes/assets/js/32.05ff8283.js"><link rel="prefetch" href="/node-learning-notes/assets/js/33.b095bc5b.js"><link rel="prefetch" href="/node-learning-notes/assets/js/34.ec57608e.js"><link rel="prefetch" href="/node-learning-notes/assets/js/35.5f3ea3ae.js"><link rel="prefetch" href="/node-learning-notes/assets/js/36.ef51b036.js"><link rel="prefetch" href="/node-learning-notes/assets/js/37.8351c418.js"><link rel="prefetch" href="/node-learning-notes/assets/js/38.a20ee99d.js"><link rel="prefetch" href="/node-learning-notes/assets/js/39.88094c54.js"><link rel="prefetch" href="/node-learning-notes/assets/js/40.084cc24a.js"><link rel="prefetch" href="/node-learning-notes/assets/js/41.ceec190d.js"><link rel="prefetch" href="/node-learning-notes/assets/js/42.310c61ee.js"><link rel="prefetch" href="/node-learning-notes/assets/js/43.5b70b2d9.js"><link rel="prefetch" href="/node-learning-notes/assets/js/44.060a5dcd.js"><link rel="prefetch" href="/node-learning-notes/assets/js/45.8363b81b.js"><link rel="prefetch" href="/node-learning-notes/assets/js/46.4397f3e0.js"><link rel="prefetch" href="/node-learning-notes/assets/js/47.2ea413fc.js"><link rel="prefetch" href="/node-learning-notes/assets/js/48.aa2c07fb.js"><link rel="prefetch" href="/node-learning-notes/assets/js/49.14a61d03.js"><link rel="prefetch" href="/node-learning-notes/assets/js/5.36c9e133.js"><link rel="prefetch" href="/node-learning-notes/assets/js/50.eb271fd9.js"><link rel="prefetch" href="/node-learning-notes/assets/js/51.bc775c5f.js"><link rel="prefetch" href="/node-learning-notes/assets/js/52.fa54eb4e.js"><link rel="prefetch" href="/node-learning-notes/assets/js/53.1ee619d8.js"><link rel="prefetch" href="/node-learning-notes/assets/js/54.5d6b9ae6.js"><link rel="prefetch" href="/node-learning-notes/assets/js/55.1d902dc8.js"><link rel="prefetch" href="/node-learning-notes/assets/js/56.35cf11c3.js"><link rel="prefetch" href="/node-learning-notes/assets/js/57.a9d87e28.js"><link rel="prefetch" href="/node-learning-notes/assets/js/58.002141b4.js"><link rel="prefetch" href="/node-learning-notes/assets/js/59.b81489d4.js"><link rel="prefetch" href="/node-learning-notes/assets/js/6.58217116.js"><link rel="prefetch" href="/node-learning-notes/assets/js/60.c35e60a8.js"><link rel="prefetch" href="/node-learning-notes/assets/js/61.f822b13d.js"><link rel="prefetch" href="/node-learning-notes/assets/js/62.485b4012.js"><link rel="prefetch" href="/node-learning-notes/assets/js/63.c7c2b6b5.js"><link rel="prefetch" href="/node-learning-notes/assets/js/64.5d43709b.js"><link rel="prefetch" href="/node-learning-notes/assets/js/65.b611bc8d.js"><link rel="prefetch" href="/node-learning-notes/assets/js/66.59d2a614.js"><link rel="prefetch" href="/node-learning-notes/assets/js/67.05e9a058.js"><link rel="prefetch" href="/node-learning-notes/assets/js/68.0b86b935.js"><link rel="prefetch" href="/node-learning-notes/assets/js/69.8c93eaf6.js"><link rel="prefetch" href="/node-learning-notes/assets/js/7.9ed243c7.js"><link rel="prefetch" href="/node-learning-notes/assets/js/70.177565f8.js"><link rel="prefetch" href="/node-learning-notes/assets/js/71.617d61d2.js"><link rel="prefetch" href="/node-learning-notes/assets/js/72.cda5cf3a.js"><link rel="prefetch" href="/node-learning-notes/assets/js/73.2201f15f.js"><link rel="prefetch" href="/node-learning-notes/assets/js/74.5aad0673.js"><link rel="prefetch" href="/node-learning-notes/assets/js/75.05e9ddf5.js"><link rel="prefetch" href="/node-learning-notes/assets/js/76.909eda7b.js"><link rel="prefetch" href="/node-learning-notes/assets/js/77.d9e10d0d.js"><link rel="prefetch" href="/node-learning-notes/assets/js/78.e3ab5082.js"><link rel="prefetch" href="/node-learning-notes/assets/js/79.6bea4726.js"><link rel="prefetch" href="/node-learning-notes/assets/js/8.5121c136.js"><link rel="prefetch" href="/node-learning-notes/assets/js/80.2b3a46e0.js"><link rel="prefetch" href="/node-learning-notes/assets/js/81.d8a2b86a.js"><link rel="prefetch" href="/node-learning-notes/assets/js/82.59884135.js"><link rel="prefetch" href="/node-learning-notes/assets/js/83.7dd235af.js"><link rel="prefetch" href="/node-learning-notes/assets/js/84.75f51e4b.js"><link rel="prefetch" href="/node-learning-notes/assets/js/85.6b0d363d.js"><link rel="prefetch" href="/node-learning-notes/assets/js/86.011fd32a.js"><link rel="prefetch" href="/node-learning-notes/assets/js/87.649522e0.js"><link rel="prefetch" href="/node-learning-notes/assets/js/88.d60b555e.js"><link rel="prefetch" href="/node-learning-notes/assets/js/89.b09d6659.js"><link rel="prefetch" href="/node-learning-notes/assets/js/9.c39e9c7d.js"><link rel="prefetch" href="/node-learning-notes/assets/js/90.bdd3e393.js"><link rel="prefetch" href="/node-learning-notes/assets/js/91.4c084abf.js"><link rel="prefetch" href="/node-learning-notes/assets/js/92.8751acf1.js"><link rel="prefetch" href="/node-learning-notes/assets/js/93.7c5d406d.js"><link rel="prefetch" href="/node-learning-notes/assets/js/94.9cbbda26.js"><link rel="prefetch" href="/node-learning-notes/assets/js/95.9d6d64b9.js"><link rel="prefetch" href="/node-learning-notes/assets/js/96.1f58d5ae.js"><link rel="prefetch" href="/node-learning-notes/assets/js/97.24de5796.js"><link rel="prefetch" href="/node-learning-notes/assets/js/98.81ff5119.js"><link rel="prefetch" href="/node-learning-notes/assets/js/99.047c4c86.js"><link rel="prefetch" href="/node-learning-notes/assets/js/vendors~docsearch.73734a07.js"><link rel="prefetch" href="/node-learning-notes/assets/js/vendors~notification.c14938e7.js">
    <link rel="stylesheet" href="/node-learning-notes/assets/css/0.styles.04d71374.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/node-learning-notes/" class="home-link router-link-active"><!----> <span class="site-name">Node.js学习指南</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/poetries/node-learning-notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/poetries/node-learning-notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基础篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-learning-notes/notes/base/01-环境搭建.html" class="sidebar-link">环境搭建</a></li><li><a href="/node-learning-notes/notes/base/02-node部署.html" class="sidebar-link">node部署</a></li><li><a href="/node-learning-notes/notes/base/03-基础应用.html" class="sidebar-link">基础应用</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>内置模块</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-learning-notes/notes/modules/-1.0 本地路径处理 path.html" class="sidebar-link">1.0 本地路径处理 path</a></li><li><a href="/node-learning-notes/notes/modules/-2.0 文件系统操作 fs.html" class="sidebar-link">2.0 文件系统操作 fs</a></li><li><a href="/node-learning-notes/notes/modules/-3.1 基础调试 console.html" class="sidebar-link">3.1 基础调试 console</a></li><li><a href="/node-learning-notes/notes/modules/-3.2 本地调试远程服务器上的Node代码.html" class="sidebar-link">3.2 本地调试远程服务器上的Node代码</a></li><li><a href="/node-learning-notes/notes/modules/-4.1 网络服务 http.html" class="sidebar-link">4.1 网络服务 http</a></li><li><a href="/node-learning-notes/notes/modules/-4.2 网络服务 http res.html" class="sidebar-link">4.2 网络服务 http res</a></li><li><a href="/node-learning-notes/notes/modules/-4.3 网络服务 http req.html" class="sidebar-link">4.3 网络服务 http req</a></li><li><a href="/node-learning-notes/notes/modules/-4.4 网络服务 http server.html" class="sidebar-link">4.4 网络服务 http server</a></li><li><a href="/node-learning-notes/notes/modules/-4.5 网络服务 http client.html" class="sidebar-link">4.5 网络服务 http client</a></li><li><a href="/node-learning-notes/notes/modules/-4.6 网络服务 https.html" class="sidebar-link">4.6 网络服务 https</a></li><li><a href="/node-learning-notes/notes/modules/-4.7 网络TCP net.html" class="sidebar-link">4.7 网络TCP net</a></li><li><a href="/node-learning-notes/notes/modules/-4.8 网络UDP dgram.html" class="sidebar-link">4.8 网络UDP dgram</a></li><li><a href="/node-learning-notes/notes/modules/-4.9 域名解析 dns.html" class="sidebar-link">4.9 域名解析 dns</a></li><li><a href="/node-learning-notes/notes/modules/-5.0 网络地址解析 url.html" class="sidebar-link">5.0 网络地址解析 url</a></li><li><a href="/node-learning-notes/notes/modules/-5.1 URL查询字符串 querystring.html" class="sidebar-link">5.1 URL查询字符串 querystring</a></li><li><a href="/node-learning-notes/notes/modules/-6.1 流操作 stream.html" class="sidebar-link">6.1 流操作 stream</a></li><li><a href="/node-learning-notes/notes/modules/-6.2 逐行读取 readline.html" class="sidebar-link">6.2 逐行读取 readline</a></li><li><a href="/node-learning-notes/notes/modules/-7.1 进程相关 process.html" class="sidebar-link">7.1 进程相关 process</a></li><li><a href="/node-learning-notes/notes/modules/-7.2 子进程 child.html" class="sidebar-link">7.2 子进程 child</a></li><li><a href="/node-learning-notes/notes/modules/-8.1 二进制数据 buffer.html" class="sidebar-link">8.1 二进制数据 buffer</a></li><li><a href="/node-learning-notes/notes/modules/-8.2 二进制解码 string_decoder.html" class="sidebar-link">8.2 二进制解码 string_decoder</a></li><li><a href="/node-learning-notes/notes/modules/-9.1 事件机制 events.html" class="sidebar-link">9.1 事件机制 events</a></li><li><a href="/node-learning-notes/notes/modules/-9.2 实用工具模块 util.html" class="sidebar-link">9.2 实用工具模块 util</a></li><li><a href="/node-learning-notes/notes/modules/-9.3 数据加密 crypto.html" class="sidebar-link">9.3 数据加密 crypto</a></li><li><a href="/node-learning-notes/notes/modules/-9.4 MD5入门介绍及crypto模块的应用.html" class="sidebar-link">9.4 MD5入门介绍及crypto模块的应用</a></li><li><a href="/node-learning-notes/notes/modules/-9.4 资源压缩 zlib.html" class="sidebar-link">9.4 资源压缩 zlib</a></li><li><a href="/node-learning-notes/notes/modules/-9.5 集群 cluster.html" class="active sidebar-link">9.5 集群 cluster</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-learning-notes/notes/modules/-9.5 集群 cluster.html#cluster模块概览" class="sidebar-link">cluster模块概览</a></li><li class="sidebar-sub-header"><a href="/node-learning-notes/notes/modules/-9.5 集群 cluster.html#入门实例" class="sidebar-link">入门实例</a></li><li class="sidebar-sub-header"><a href="/node-learning-notes/notes/modules/-9.5 集群 cluster.html#cluster模块实现原理" class="sidebar-link">cluster模块实现原理</a></li><li class="sidebar-sub-header"><a href="/node-learning-notes/notes/modules/-9.5 集群 cluster.html#问题1：master、worker如何通信" class="sidebar-link">问题1：master、worker如何通信</a></li><li class="sidebar-sub-header"><a href="/node-learning-notes/notes/modules/-9.5 集群 cluster.html#问题2：如何实现端口共享" class="sidebar-link">问题2：如何实现端口共享</a></li><li class="sidebar-sub-header"><a href="/node-learning-notes/notes/modules/-9.5 集群 cluster.html#master、worker内部通信小技巧" class="sidebar-link">master、worker内部通信小技巧</a></li><li class="sidebar-sub-header"><a href="/node-learning-notes/notes/modules/-9.5 集群 cluster.html#相关链接" class="sidebar-link">相关链接</a></li></ul></li><li><a href="/node-learning-notes/notes/modules/-9.6 v8.html" class="sidebar-link">9.6 v8</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>进阶篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Express</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Koa2</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-learning-notes/notes/other/01-操作数据库.html" class="sidebar-link">操作数据库</a></li><li><a href="/node-learning-notes/notes/other/02-Session 与 Token.html" class="sidebar-link">Session 与 Token</a></li><li><a href="/node-learning-notes/notes/other/03-Cookie、Session、Token、JWT.html" class="sidebar-link">Cookie、Session、Token、JWT</a></li><li><a href="/node-learning-notes/notes/other/04-Socket.html" class="sidebar-link">Socket</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="cluster模块概览"><a href="#cluster模块概览" class="header-anchor">#</a> cluster模块概览</h2> <p>node实例是单线程作业的。在服务端编程中，通常会创建多个node实例来处理客户端的请求，以此提升系统的吞吐率。对这样多个node实例，我们称之为cluster（集群）。</p> <p>借助node的cluster模块，开发者可以在几乎不修改原有项目代码的前提下，获得集群服务带来的好处。</p> <p>集群有以下两种常见的实现方案，而node自带的cluster模块，采用了方案二。</p> <h3 id="方案一：多个node实例-多个端口"><a href="#方案一：多个node实例-多个端口" class="header-anchor">#</a> 方案一：多个node实例+多个端口</h3> <p>集群内的node实例，各自监听不同的端口，再由反向代理实现请求到多个端口的分发。</p> <ul><li>优点：实现简单，各实例相对独立，这对服务稳定性有好处。</li> <li>缺点：增加端口占用，进程之间通信比较麻烦。</li></ul> <h3 id="方案二：主进程向子进程转发请求"><a href="#方案二：主进程向子进程转发请求" class="header-anchor">#</a> 方案二：主进程向子进程转发请求</h3> <p>集群内，创建一个主进程(master)，以及若干个子进程(worker)。由master监听客户端连接请求，并根据特定的策略，转发给worker。</p> <ul><li>优点：通常只占用一个端口，通信相对简单，转发策略更灵活。</li> <li>缺点：实现相对复杂，对主进程的稳定性要求较高。</li></ul> <h2 id="入门实例"><a href="#入门实例" class="header-anchor">#</a> 入门实例</h2> <p>在cluster模块中，主进程称为master，子进程称为worker。</p> <p>例子如下，创建与CPU数目相同的服务端实例，来处理客户端请求。注意，它们监听的都是同样的端口。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token keyword">var</span> cluster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cluster'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> cpuNums <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cpuNums<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
  http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">response from worker </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Worker </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> started</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>创建批处理脚本：./req.sh。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>

<span class="token comment"># req.sh</span>
<span class="token keyword">for</span><span class="token variable"><span class="token punctuation">((</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">4</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">))</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>   
  <span class="token function">curl</span> http://127.0.0.1:3000
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;&quot;</span>
<span class="token keyword">done</span> 
</code></pre></div><p>输出如下。可以看到，响应来自不同的进程。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>response from worker <span class="token number">23735</span>
response from worker <span class="token number">23731</span>
response from worker <span class="token number">23729</span>
response from worker <span class="token number">23730</span>
</code></pre></div><h2 id="cluster模块实现原理"><a href="#cluster模块实现原理" class="header-anchor">#</a> cluster模块实现原理</h2> <p>了解cluster模块，主要搞清楚3个问题：</p> <ol><li>master、worker如何通信？</li> <li>多个server实例，如何实现端口共享？</li> <li>多个server实例，来自客户端的请求如何分发到多个worker？</li></ol> <p>下面会结合示意图进行介绍，源码级别的介绍，可以参考 <a href="https://github.com/chyingp/nodejs-learning-guide" target="_blank" rel="noopener noreferrer">笔者的github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="问题1：master、worker如何通信"><a href="#问题1：master、worker如何通信" class="header-anchor">#</a> 问题1：master、worker如何通信</h2> <p>这个问题比较简单。master进程通过 cluster.fork() 来创建 worker进程。cluster.fork() 内部 是通过 child_process.fork() 来创建子进程。</p> <p>也就是说：</p> <ol><li>master进程、worker进程是父、子进程的关系。</li> <li>master进程、woker进程可以通过IPC通道进行通信。（重要）</li></ol> <h2 id="问题2：如何实现端口共享"><a href="#问题2：如何实现端口共享" class="header-anchor">#</a> 问题2：如何实现端口共享</h2> <p>在前面的例子中，多个woker中创建的server监听了同个端口3000。通常来说，多个进程监听同个端口，系统会报错。</p> <p>为什么我们的例子没问题呢？</p> <p>秘密在于，net模块中，对 listen() 方法进行了特殊处理。根据当前进程是master进程，还是worker进程：</p> <ol><li>master进程：在该端口上正常监听请求。（没做特殊处理）</li> <li>worker进程：创建server实例。然后通过IPC通道，向master进程发送消息，让master进程也创建 server 实例，并在该端口上监听请求。当请求进来时，master进程将请求转发给worker进程的server实例。</li></ol> <p>归纳起来，就是：master进程监听特定端口，并将客户请求转发给worker进程。</p> <p>如下图所示：</p> <p><img src="https://www.chyingp.com/wp-content/uploads/2018/04/4c1692183865cb201df83f8ee357d070.png" alt=""></p> <h3 id="问题3：如何将请求分发到多个worker"><a href="#问题3：如何将请求分发到多个worker" class="header-anchor">#</a> 问题3：如何将请求分发到多个worker</h3> <p>每当worker进程创建server实例来监听请求，都会通过IPC通道，在master上进行注册。当客户端请求到达，master会负责将请求转发给对应的worker。</p> <p>具体转发给哪个worker？这是由转发策略决定的。可以通过环境变量NODE_CLUSTER_SCHED_POLICY设置，也可以在cluster.setupMaster(options)时传入。</p> <p>默认的转发策略是轮询（SCHED_RR）。</p> <p>当有客户请求到达，master会轮询一遍worker列表，找到第一个空闲的worker，然后将该请求转发给该worker。</p> <h2 id="master、worker内部通信小技巧"><a href="#master、worker内部通信小技巧" class="header-anchor">#</a> master、worker内部通信小技巧</h2> <p>在开发过程中，我们会通过 process.on('message', fn) 来实现进程间通信。</p> <p>前面提到，master进程、worker进程在server实例的创建过程中，也是通过IPC通道进行通信的。那会不会对我们的开发造成干扰呢？比如，收到一堆其实并不需要关心的消息？</p> <p>答案肯定是不会？那么是怎么做到的呢？</p> <p>当发送的消息包含<code>cmd</code>字段，且改字段以<code>NODE_</code>作为前缀，则该消息会被视为内部保留的消息，不会通过<code>message</code>事件抛出，但可以通过监听'internalMessage'捕获。</p> <p>以worker进程通知master进程创建server实例为例子。worker伪代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// woker进程</span>
<span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token punctuation">{</span>
  cmd<span class="token operator">:</span> <span class="token string">'NODE_CLUSTER'</span><span class="token punctuation">,</span>
  act<span class="token operator">:</span> <span class="token string">'queryServer'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>master伪代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>worker<span class="token punctuation">.</span>process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'internalMessage'</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="相关链接"><a href="#相关链接" class="header-anchor">#</a> 相关链接</h2> <p>官方文档：<a href="https://nodejs.org/api/cluster.html" target="_blank" rel="noopener noreferrer">https://nodejs.org/api/cluster.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Node学习笔记：<a href="https://github.com/chyingp/nodejs-learning-guide" target="_blank" rel="noopener noreferrer">https://github.com/chyingp/nodejs-learning-guide<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/node-learning-notes/notes/modules/-9.4 资源压缩 zlib.html" class="prev">
        9.4 资源压缩 zlib
      </a></span> <span class="next"><a href="/node-learning-notes/notes/modules/-9.6 v8.html">
        9.6 v8
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/node-learning-notes/assets/js/app.06995101.js" defer></script><script src="/node-learning-notes/assets/js/4.cbb566af.js" defer></script><script src="/node-learning-notes/assets/js/102.bed33a4e.js" defer></script>
  </body>
</html>
